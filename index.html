<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUZA FARMA - InteligÃªncia Cloud</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #d32f2f; --secondary: #fbc02d; --success: #2e7d32; --light: #f8f9fa; --blue: #0277bd; --dark: #263238; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #eaeff2; color: #333; }
        
        #loginScreen { display: none; align-items: center; justify-content: center; height: 100vh; background: var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 320px; border-top: 8px solid var(--primary); }
        
        #mainApp { display: none; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .logo-img { max-width: 180px; height: auto; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
        .nome-farmacia { color: var(--primary); font-size: 32px; font-weight: 900; margin: 0; text-transform: uppercase; }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .card-vendas { background: var(--blue); } .card-lucro { background: var(--success); } .card-margem { background: #5e35b1; }
        .card p { margin: 5px 0 0; font-size: 22px; font-weight: bold; }

        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-container { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; height: 280px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; border: none; background: #cfd8dc; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }

        .form-container { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        .form-grid { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1.2fr 1fr auto; gap: 10px; }
        
        input, select, button { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; cursor: pointer; font-weight: bold; border:none; }
        .btn-update { background: var(--secondary); color: #333; display: none; cursor: pointer; font-weight: bold; border:none; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        .high-priority { border-left: 8px solid #ff1744 !important; background: #fff1f1; }
        .badge-abc { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: white; }
        
        .footer-controls { display: flex; gap: 10px; margin-top: 30px; justify-content: center; flex-wrap: wrap; }
        .btn-action { padding: 12px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        @media print {
            .no-print { display: none !important; }
            body.thermal-mode-active { width: 70mm; font-family: "Arial Black", sans-serif !important; }
            body.thermal-mode-active .container { width: 70mm !important; padding: 0.5cm !important; margin: 0 !important; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h1 style="color: var(--primary); margin: 0; font-size: 28px;">SOUZA FARMA</h1>
        <input type="password" id="passInput" placeholder="Senha" style="width: 80%; margin-top: 15px; text-align: center;"><br>
        <button onclick="checkLogin()" class="btn-add" style="width: 100%; margin-top: 15px;">ENTRAR</button>
    </div>
</div>

<div id="mainApp">
    <div class="container">
        <header>
            <h1 class="nome-farmacia">SOUZA FARMA</h1>
            <p style="font-size: 12px; color: #666;">RelatÃ³rio em Nuvem Real-time</p>
        </header>

        <div class="dashboard no-print">
            <div class="card card-vendas"><h4>Perda Bruta</h4><p id="dashVenda">R$ 0,00</p></div>
            <div class="card card-lucro"><h4>Lucro Cessante</h4><p id="dashLucro">R$ 0,00</p></div>
            <div class="card card-margem"><h4>Margem</h4><p id="dashMargem">0%</p></div>
        </div>

        <div class="charts-row no-print">
            <div class="chart-container"><canvas id="graficoBarras"></canvas></div>
            <div class="chart-container"><canvas id="graficoPizza"></canvas></div>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" id="btnTabFaltas" onclick="switchTab('faltas')">ðŸ›’ Faltas</button>
            <button class="tab-btn" id="btnTabHist" onclick="switchTab('historico')">âœ… HistÃ³rico</button>
        </div>

        <div id="areaFaltas">
            <div class="form-container no-print">
                <div class="form-grid">
                    <input type="text" id="desc" placeholder="Medicamento">
                    <input type="number" id="qtd" placeholder="Qtd">
                    <input type="number" id="custo" placeholder="Custo" step="0.01">
                    <input type="number" id="venda" placeholder="Venda" step="0.01">
                    <select id="motivo">
                        <option value="Estoque Zerado">Estoque Zerado</option>
                        <option value="Fornecedor IndisponÃ­vel">Fornecedor IndisponÃ­vel</option>
                        <option value="Produto Novo">Produto Novo</option>
                    </select>
                    <input type="date" id="dataReg">
                    <button id="btnAdd" class="btn-add" onclick="adicionarAoFirebase()">SALVAR</button>
                    <button id="btnUpdate" class="btn-update" onclick="salvarEdicaoFirebase()">ATUALIZAR</button>
                </div>
                <input type="hidden" id="editId">
            </div>
            <table>
                <thead><tr><th>Produto</th><th>Qtd</th><th>PreÃ§os</th><th>Lucro Total</th><th>Total</th><th class="no-print">AÃ§Ãµes</th></tr></thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

        <div id="areaHistorico" style="display:none;">
            <table>
                <thead><tr><th>Produto</th><th>Data Falta</th><th>Data Compra</th><th>PreÃ§o MÃ©dio</th><th>AÃ§Ãµes</th></tr></thead>
                <tbody id="corpoHistorico"></tbody>
            </table>
        </div>

        <div class="footer-controls no-print">
            <button class="btn-action" style="background:#d32f2f" onclick="gerarPDF()">ðŸ“‘ PDF</button>
            <button class="btn-action" style="background:#1565c0" onclick="exportarExcel()">ðŸ“Š EXCEL</button>
            <button class="btn-action" style="background:#263238" onclick="imprimir('70mm')">ðŸ§¾ TÃ‰RMICA</button>
            <button class="btn-action" style="background:#25d366" onclick="enviarWhatsApp()">ðŸ“² WHATSAPP</button>
            <button class="btn-action" style="background:#757575" onclick="logout()">ðŸ”’ SAIR</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC5-jTow8lk34iaKFhuSmJ8c1QpgoExOfE",
        authDomain: "souza-farma-8d08d.firebaseapp.com",
        databaseURL: "https://souza-farma-8d08d-default-rtdb.firebaseio.com",
        projectId: "souza-farma-8d08d",
        storageBucket: "souza-farma-8d08d.firebasestorage.app",
        messagingSenderId: "189166520636",
        appId: "1:189166520636:web:c97b7c7ead4e2d32b67639"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dados = [];
    let barChart, pieChart;

    window.onload = () => {
        if(sessionStorage.getItem('logado') === 'true') { 
            document.getElementById('mainApp').style.display = 'block';
            carregarDados();
        } else { document.getElementById('loginScreen').style.display = 'flex'; }
        document.getElementById('dataReg').valueAsDate = new Date();
    };

    function checkLogin() { if(document.getElementById('passInput').value === 'farma123') { sessionStorage.setItem('logado', 'true'); location.reload(); } else alert("Senha Incorreta!"); }
    function logout() { sessionStorage.removeItem('logado'); location.reload(); }
    function switchTab(t) {
        document.getElementById('areaFaltas').style.display = t === 'faltas' ? 'block' : 'none';
        document.getElementById('areaHistorico').style.display = t === 'historico' ? 'block' : 'none';
        document.getElementById('btnTabFaltas').classList.toggle('active', t === 'faltas');
        document.getElementById('btnTabHist').classList.toggle('active', t === 'historico');
    }

    function carregarDados() {
        db.ref('faltas').on('value', snap => {
            dados = [];
            snap.forEach(i => { dados.push({id: i.key, ...i.val()}); });
            renderizar();
            atualizarGraficos();
        });
    }

    function renderizar() {
        const corpo = document.getElementById('corpoTabela');
        const corpoH = document.getElementById('corpoHistorico');
        corpo.innerHTML = ''; corpoH.innerHTML = '';
        let tV = 0, tL = 0;

        [...dados].reverse().forEach(i => {
            const lucroT = (i.venda - i.custo) * i.qtd;
            const totalV = i.venda * i.qtd;

            if(!i.comprado) {
                tV += totalV; tL += lucroT;
                let abc = lucroT >= 50 ? 'high-priority' : '';
                corpo.innerHTML += `<tr class="${abc}">
                    <td><strong>${i.desc}</strong><br><small>${i.data} | ${i.motivo}</small></td>
                    <td>${i.qtd}</td>
                    <td>C: ${i.custo.toFixed(2)} | V: ${i.venda.toFixed(2)}</td>
                    <td>R$ ${lucroT.toFixed(2)}</td>
                    <td><strong>R$ ${totalV.toFixed(2)}</strong></td>
                    <td class="no-print">
                        <button onclick="marcarComprado('${i.id}')">âœ…</button>
                        <button onclick="editarItem('${i.id}')" style="margin-left:5px">âœŽ</button>
                    </td></tr>`;
            } else {
                // LÃ“GICA DE PREÃ‡O MÃ‰DIO/VARIAÃ‡ÃƒO
                const comprasAnteriores = dados.filter(x => x.desc === i.desc && x.comprado && x.id !== i.id);
                let trend = "â€“";
                if(comprasAnteriores.length > 0) {
                    const ultima = comprasAnteriores[0].custo;
                    trend = i.custo > ultima ? "ðŸ”º" : (i.custo < ultima ? "ðŸ”»" : "â€“");
                }
                corpoH.innerHTML += `<tr>
                    <td><strong>${i.desc}</strong></td>
                    <td>${i.data}</td>
                    <td>${i.dataCompra}</td>
                    <td>R$ ${i.custo.toFixed(2)} ${trend}</td>
                    <td><button onclick="estornar('${i.id}')" style="font-size:10px">â†© REVERTER</button></td></tr>`;
            }
        });
        document.getElementById('dashVenda').innerText = `R$ ${tV.toFixed(2)}`;
        document.getElementById('dashLucro').innerText = `R$ ${tL.toFixed(2)}`;
        document.getElementById('dashMargem').innerText = tV > 0 ? ((tL/tV)*100).toFixed(1) + "%" : "0%";
    }

    function atualizarGraficos() {
        // GrÃ¡fico de Barras (EvoluÃ§Ã£o)
        const dias = {};
        dados.filter(i => !i.comprado).forEach(i => dias[i.data] = (dias[i.data] || 0) + (i.venda * i.qtd));
        const labels = Object.keys(dias).slice(-7);
        if(barChart) barChart.destroy();
        barChart = new Chart(document.getElementById('graficoBarras'), {
            type: 'bar', data: { labels, datasets: [{label: 'Perda R$', data: labels.map(l => dias[l]), backgroundColor: '#d32f2f'}]}
        });

        // GrÃ¡fico de Pizza (Motivos)
        const m = { 'Estoque Zerado': 0, 'Fornecedor IndisponÃ­vel': 0, 'Produto Novo': 0 };
        dados.filter(i => !i.comprado).forEach(i => m[i.motivo]++);
        if(pieChart) pieChart.destroy();
        pieChart = new Chart(document.getElementById('graficoPizza'), {
            type: 'pie', data: { labels: Object.keys(m), datasets: [{data: Object.values(m), backgroundColor: ['#0277bd', '#fbc02d', '#2e7d32']}]},
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    }

    function adicionarAoFirebase() {
        const d = document.getElementById('desc').value.toUpperCase();
        const q = parseFloat(document.getElementById('qtd').value);
        if(!d || !q) return alert("Preencha Medicamento e Qtd!");
        db.ref('faltas').push({
            desc: d, qtd: q, custo: parseFloat(document.getElementById('custo').value)||0,
            venda: parseFloat(document.getElementById('venda').value)||0,
            motivo: document.getElementById('motivo').value,
            rawDate: document.getElementById('dataReg').value,
            data: document.getElementById('dataReg').value.split('-').reverse().join('/'),
            comprado: false
        });
        document.getElementById('desc').value=''; document.getElementById('qtd').value='';
    }

    function marcarComprado(id) { db.ref('faltas/'+id).update({comprado:true, dataCompra: new Date().toLocaleDateString('pt-BR')}); }
    function estornar(id) { db.ref('faltas/'+id).update({comprado:false, dataCompra:null}); }
    
    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("SOUZA FARMA - RELATÃ“RIO DE GESTÃƒO", 14, 15);
        const rows = dados.filter(i => !i.comprado).map(i => [i.desc, i.qtd, i.data, i.motivo, 'R$ '+ (i.venda*i.qtd).toFixed(2)]);
        doc.autoTable({ head: [['Produto', 'Qtd', 'Data', 'Motivo', 'Total']], body: rows, startY: 25 });
        doc.save("relatorio_souza_farma.pdf");
    }

    function exportarExcel() {
        let csv = '\uFEFFData;Produto;Qtd;Custo;Venda;Motivo\n';
        dados.forEach(i => csv += `${i.data};${i.desc};${i.qtd};${i.custo};${i.venda};${i.motivo}\n`);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        link.download = "souza_farma.csv"; link.click();
    }

    function imprimir(f) { if(f==='70mm') document.body.classList.add('thermal-mode-active'); setTimeout(() => { window.print(); document.body.classList.remove('thermal-mode-active'); }, 500); }
    function enviarWhatsApp() {
        let m = "*SOUZA FARMA - FALTAS ATUAIS*%0A";
        dados.filter(i => !i.comprado).forEach(i => m += `â€¢ ${i.desc} (${i.qtd})%0A`);
        window.open(`https://wa.me/5598986287296?text=${m}`);
    }
</script>
</body>
</html>
