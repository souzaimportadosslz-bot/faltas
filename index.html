<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Souza Farma - Online Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #d32f2f; --secondary: #fbc02d; --success: #2e7d32; --light: #f8f9fa; --blue: #0277bd; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #eaeff2; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        header h1 { margin: 0; color: var(--primary); text-transform: uppercase; font-size: 24px; }
        .info-farma { font-size: 13px; color: #555; margin-top: 5px; }

        /* Dashboard de Lucros */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 15px; border-radius: 8px; color: white; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card-vendas { background: var(--blue); }
        .card-lucro { background: var(--success); }
        .card-margem { background: #5e35b1; }
        .card h4 { margin: 0; font-size: 11px; text-transform: uppercase; opacity: 0.9; }
        .card p { margin: 5px 0 0; font-size: 20px; font-weight: bold; }

        /* Formul√°rio */
        .form-container { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        .form-grid { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1.2fr auto; gap: 10px; }
        input, button { padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; }
        
        .btn-add { background: var(--primary); color: white; cursor: pointer; font-weight: bold; border:none; }
        .btn-update { background: var(--secondary); display: none; cursor: pointer; font-weight: bold; border:none; }
        
        /* Tabela Visual */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #37474f; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f1f1f1; }

        .footer-controls { display: flex; gap: 10px; margin-top: 30px; justify-content: center; }
        .btn-action { padding: 12px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-action:hover { opacity: 0.8; }

        /* ================= AJUSTE T√âRMICO 70mm (LETRAS VIVAS) ================= */
        @media print {
            .no-print { display: none !important; }
            
            body.thermal-mode-active {
                background: white; margin: 0; padding: 0; width: 70mm;
                font-family: "Arial Black", Gadget, sans-serif !important; 
                color: #000 !important;
            }

            body.thermal-mode-active .container {
                width: 70mm !important; max-width: 70mm !important;
                padding: 0.5cm !important; margin: 0 !important;
                box-shadow: none !important; border: none !important;
            }

            body.thermal-mode-active * {
                color: #000 !important; 
                font-weight: 900 !important; /* For√ßa queima total do papel */
            }

            body.thermal-mode-active table { font-size: 12px !important; width: 100% !important; }
            body.thermal-mode-active th, body.thermal-mode-active td {
                padding: 5px 0 !important;
                border-bottom: 2px solid #000 !important; /* Linha divis√≥ria bem vis√≠vel */
            }

            body.thermal-mode-active header h1 { font-size: 18px !important; }
            body.thermal-mode-active .info-farma { font-size: 10px !important; }

            @page { margin: 0; }
            body.thermal-mode-active @page { size: 70mm auto; }
        }
    </style>
</head>
<body>

<div class="container" id="printableArea">
    <header>
        <h1>Souza Farma</h1>
        <div class="info-farma">
            <strong>Farm√°cia do Trabalhador</strong><br>
            A Neto E Souza ‚Äì CNPJ 45.856.880/0001-30<br>
            Av. Jos√© Sarney n¬∫ 06, Bom Jesus ‚Äì S√£o Lu√≠s/MA
        </div>
    </header>

    <div id="loader" class="no-print" style="text-align:center; padding:10px; color:var(--blue); font-weight: bold;">
        Carregando dados da Nuvem Souza Farma...
    </div>

    <div class="no-print">
        <div class="dashboard">
            <div class="card card-vendas"><h4>Vendas Perdidas</h4><p id="dashVenda">R$ 0,00</p></div>
            <div class="card card-lucro"><h4>Lucro Perdido</h4><p id="dashLucro">R$ 0,00</p></div>
            <div class="card card-margem"><h4>Margem M√©dia (%)</h4><p id="dashMargem">0,00%</p></div>
        </div>

        <div class="form-container">
            <div class="form-grid">
                <input type="text" id="desc" placeholder="Medicamento">
                <input type="number" id="qtd" placeholder="Qtd">
                <input type="number" id="custo" placeholder="Custo Unit." step="0.01">
                <input type="number" id="venda" placeholder="Venda Unit." step="0.01">
                <input type="date" id="dataReg">
                <button id="btnAdd" class="btn-add" onclick="adicionarAoFirebase()">SALVAR</button>
                <button id="btnUpdate" class="btn-update" onclick="salvarEdicaoFirebase()">ATUALIZAR</button>
            </div>
            <input type="hidden" id="editId">
        </div>
    </div>

    <div id="tabelaArea">
        <table>
            <thead>
                <tr>
                    <th>Data/Produto</th>
                    <th>Qtd</th>
                    <th>Pre√ßo Venda</th>
                    <th class="no-print">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
            <tfoot>
                <tr style="border-top: 3px solid #000;">
                    <td colspan="2" align="right"><strong>TOTAL EM VENDAS:</strong></td>
                    <td id="totalFinalTabela" style="font-weight: bold; color: #000;">R$ 0,00</td>
                    <td class="no-print"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="footer-controls no-print">
        <button class="btn-action" style="background:#455a64" onclick="imprimir('A4')">üñ®Ô∏è IMPRIMIR A4</button>
        <button class="btn-action" style="background:#263238" onclick="imprimir('70mm')">üßæ T√âRMICA 70mm</button>
        <button class="btn-action" style="background:#25d366" onclick="enviarWhatsApp()">üì≤ WHATSAPP</button>
    </div>
</div>

<script>
    // Configura√ß√µes do seu Firebase vinculadas com sucesso
    const firebaseConfig = {
        apiKey: "AIzaSyC5-jTow8lk34iaKFhuSmJ8c1QpgoExOfE",
        authDomain: "souza-farma-8d08d.firebaseapp.com",
        databaseURL: "https://souza-farma-8d08d-default-rtdb.firebaseio.com",
        projectId: "souza-farma-8d08d",
        storageBucket: "souza-farma-8d08d.firebasestorage.app",
        messagingSenderId: "189166520636",
        appId: "1:189166520636:web:c97b7c7ead4e2d32b67639"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    document.getElementById('dataReg').valueAsDate = new Date();

    // Salvar Dados
    function adicionarAoFirebase() {
        const desc = document.getElementById('desc').value;
        const qtd = parseFloat(document.getElementById('qtd').value);
        const custo = parseFloat(document.getElementById('custo').value) || 0;
        const venda = parseFloat(document.getElementById('venda').value) || 0;
        const data = document.getElementById('dataReg').value;

        if(!desc || !qtd || !venda) return alert("Por favor, preencha o Medicamento, Quantidade e Valor de Venda.");

        db.ref('faltas').push({
            desc: desc.toUpperCase(),
            qtd, custo, venda,
            data: data.split('-').reverse().join('/'),
            rawDate: data,
            timestamp: Date.now()
        });
        limparCampos();
    }

    // Monitorar Nuvem em Tempo Real
    db.ref('faltas').on('value', (snapshot) => {
        document.getElementById('loader').style.display = 'none';
        const lista = [];
        snapshot.forEach((item) => { lista.push({ id: item.key, ...item.val() }); });
        renderizar(lista);
    });

    function renderizar(lista) {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';
        let tVenda = 0, tCusto = 0;

        // Mostrar os mais novos primeiro
        lista.reverse().forEach(i => {
            const vendaTotalItem = i.venda * i.qtd;
            tVenda += vendaTotalItem;
            tCusto += i.custo * i.qtd;

            corpo.innerHTML += `
                <tr>
                    <td><small>${i.data}</small><br><strong>${i.desc}</strong></td>
                    <td>${i.qtd}</td>
                    <td>R$ ${vendaTotalItem.toFixed(2)}</td>
                    <td class="no-print">
                        <button onclick="editarItem('${i.id}')" style="cursor:pointer; border:none; background:none;">‚úé</button>
                        <button onclick="removerItem('${i.id}')" style="color:red; cursor:pointer; border:none; background:none; margin-left:10px;">üóë</button>
                    </td>
                </tr>`;
        });
        
        const lucroTotal = tVenda - tCusto;
        const margemMedia = tVenda > 0 ? (lucroTotal / tVenda) * 100 : 0;

        document.getElementById('dashVenda').innerText = `R$ ${tVenda.toFixed(2)}`;
        document.getElementById('dashLucro').innerText = `R$ ${lucroTotal.toFixed(2)}`;
        document.getElementById('dashMargem').innerText = `${margemMedia.toFixed(2)}%`;
        document.getElementById('totalFinalTabela').innerText = `R$ ${tVenda.toFixed(2)}`;
    }

    function editarItem(id) {
        db.ref('faltas/' + id).once('value', (s) => {
            const i = s.val();
            document.getElementById('desc').value = i.desc;
            document.getElementById('qtd').value = i.qtd;
            document.getElementById('custo').value = i.custo;
            document.getElementById('venda').value = i.venda;
            document.getElementById('dataReg').value = i.rawDate;
            document.getElementById('editId').value = id;
            document.getElementById('btnAdd').style.display = 'none';
            document.getElementById('btnUpdate').style.display = 'block';
            window.scrollTo(0,0);
        });
    }

    function salvarEdicaoFirebase() {
        const id = document.getElementById('editId').value;
        const data = document.getElementById('dataReg').value;
        db.ref('faltas/' + id).update({
            desc: document.getElementById('desc').value.toUpperCase(),
            qtd: parseFloat(document.getElementById('qtd').value),
            custo: parseFloat(document.getElementById('custo').value),
            venda: parseFloat(document.getElementById('venda').value),
            rawDate: data,
            data: data.split('-').reverse().join('/')
        });
        document.getElementById('btnAdd').style.display = 'block';
        document.getElementById('btnUpdate').style.display = 'none';
        limparCampos();
    }

    function removerItem(id) {
        if(confirm("Deseja apagar esse registro da nuvem?")) db.ref('faltas/' + id).remove();
    }

    function imprimir(formato) {
        if (formato === '70mm') {
            document.body.classList.add('thermal-mode-active');
        } else {
            document.body.classList.remove('thermal-mode-active');
        }
        
        setTimeout(() => {
            window.print();
            setTimeout(()=> document.body.classList.remove('thermal-mode-active'), 1000);
        }, 400);
    }

    function limparCampos() {
        document.getElementById('desc').value = '';
        document.getElementById('qtd').value = '';
        document.getElementById('custo').value = '';
        document.getElementById('venda').value = '';
    }

    function enviarWhatsApp() {
        const venda = document.getElementById('dashVenda').innerText;
        const lucro = document.getElementById('dashLucro').innerText;
        const margem = document.getElementById('dashMargem').innerText;
        let msg = `*SOUZA FARMA - RELAT√ìRIO DE PERDAS*%0A%0A`;
        msg += `Total Perdido: ${venda}%0A`;
        msg += `Lucro Deixado de Ganhar: ${lucro}%0A`;
        msg += `Margem M√©dia: ${margem}%0A%0A`;
        msg += `_Cuidando da sua sa√∫de, economia e pre√ßo baixo._`;
        window.open(`https://wa.me/5598986287296?text=${msg}`);
    }
</script>
</body>
</html>