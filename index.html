<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUZA FARMA - Intelig√™ncia Cloud</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #d32f2f; --secondary: #fbc02d; --success: #2e7d32; --light: #f8f9fa; --blue: #0277bd; --dark: #263238; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #eaeff2; color: #333; }
        
        /* Login - MANTIDO IGUAL COM LOGO */
        #loginScreen { display: none; align-items: center; justify-content: center; height: 100vh; background: var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 320px; border-top: 8px solid var(--primary); }
        
        /* App */
        #mainApp { display: none; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .logo-img { max-width: 180px; height: auto; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }
        .nome-farmacia { color: var(--primary); font-size: 32px; font-weight: 900; margin: 0; text-transform: uppercase; letter-spacing: -1px; }
        .info-farma { font-size: 13px; color: #555; margin-top: 5px; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .card-vendas { background: var(--blue); } .card-lucro { background: var(--success); } .card-margem { background: #5e35b1; }
        .card p { margin: 5px 0 0; font-size: 22px; font-weight: bold; }

        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-container { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; height: 280px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 12px 25px; border: none; background: #cfd8dc; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* NOVO: FILTROS DE DATA */
        .filtros-container {
            background: #f1f8e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c5e1a5;
        }
        
        .filtros-titulo {
            color: #33691e;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filtros-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 10px;
            align-items: end;
        }
        
        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filtro-label {
            font-size: 12px;
            color: #555;
            font-weight: 600;
        }
        
        .btn-filtro {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .btn-limpar {
            background: #757575;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        
        .filtro-info {
            grid-column: 1 / -1;
            font-size: 12px;
            color: #666;
            padding-top: 5px;
            border-top: 1px dashed #ddd;
            margin-top: 5px;
        }

        .form-container { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        .form-grid { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1.2fr 1fr auto; gap: 10px; }
        
        input, select, button { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; cursor: pointer; font-weight: bold; border:none; }
        .btn-update { background: var(--secondary); color: #333; display: none; cursor: pointer; font-weight: bold; border:none; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        .high-priority { border-left: 8px solid #ff1744 !important; background: #fff1f1; }
        .badge-abc { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: white; display: inline-block; margin-top: 5px; }
        .badge-red { background: #ff1744; }
        .badge-green { background: #00c853; }

        .footer-controls { display: flex; gap: 10px; margin-top: 30px; justify-content: center; flex-wrap: wrap; }
        .btn-action { padding: 12px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* CORRE√á√ÉO DA IMPRESS√ÉO T√âRMICA - IMPRESS√ÉO FORTE E ESCURA */
        @media print {
            body * {
                visibility: hidden;
            }
            
            body.thermal-mode-active {
                visibility: visible;
                width: 70mm !important;
                min-width: 70mm !important;
                max-width: 70mm !important;
                margin: 0 !important;
                padding: 0 !important;
                font-size: 10px !important;
                line-height: 1 !important;
                background: white !important;
                color: #000000 !important; /* PRETO PURO PARA IMPRESS√ÉO FORTE */
                font-weight: bold !important; /* TEXTO MAIS FORTE */
            }
            
            body.thermal-mode-active * {
                visibility: visible !important;
                color: #000000 !important; /* FOR√áAR PRETO EM TODOS OS ELEMENTOS */
                font-family: "Arial Black", "Arial", sans-serif !important; /* FONTE MAIS FORTE */
                text-shadow: none !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body.thermal-mode-active .container {
                width: 68mm !important;
                min-width: 68mm !important;
                max-width: 68mm !important;
                margin: 0 auto !important;
                padding: 1mm !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                background: white !important;
            }
            
            body.thermal-mode-active header {
                text-align: center;
                padding-bottom: 1mm;
                margin-bottom: 2mm;
                border-bottom: 2px solid #000 !important; /* LINHA MAIS GROSSA */
            }
            
            body.thermal-mode-active .logo-img {
                max-width: 25mm !important;
                margin: 0 auto 1mm !important;
                filter: brightness(0) !important; /* LOGO EM PRETO PURO */
            }
            
            body.thermal-mode-active .nome-farmacia {
                font-size: 12px !important;
                margin: 0 !important;
                line-height: 1 !important;
                font-weight: 900 !important;
                color: #000 !important;
            }
            
            body.thermal-mode-active .info-farma {
                font-size: 8px !important;
                margin: 1mm 0 !important;
                line-height: 1 !important;
                font-weight: bold !important;
                color: #000 !important;
            }
            
            body.thermal-mode-active table {
                width: 100% !important;
                font-size: 9px !important;
                border-collapse: collapse;
                border: 2px solid #000 !important; /* BORDA GROSSA */
            }
            
            body.thermal-mode-active th,
            body.thermal-mode-active td {
                padding: 1mm 0.5mm !important;
                border: 1px solid #000 !important; /* BORDAS PRETAS */
                font-size: 9px !important;
                line-height: 1 !important;
                font-weight: bold !important;
                color: #000 !important;
                background: white !important;
            }
            
            body.thermal-mode-active th {
                background: #000 !important; /* CABE√áALHO PRETO */
                color: #fff !important; /* TEXTO BRANCO NO CABE√áALHO */
                font-weight: 900 !important;
                border: 1px solid #000 !important;
            }
            
            body.thermal-mode-active tr {
                page-break-inside: avoid;
                border: 1px solid #000 !important;
            }
            
            /* REMOVER ELEMENTOS N√ÉO NECESS√ÅRIOS */
            body.thermal-mode-active .no-print,
            body.thermal-mode-active .dashboard,
            body.thermal-mode-active .charts-row,
            body.thermal-mode-active .tabs,
            body.thermal-mode-active .form-container,
            body.thermal-mode-active .footer-controls,
            body.thermal-mode-active button,
            body.thermal-mode-active .badge-abc,
            body.thermal-mode-active .high-priority,
            body.thermal-mode-active .filtros-container {
                display: none !important;
            }
            
            /* IMPRIMIR APENAS A TABELA DE FALTAS */
            body.thermal-mode-active #areaHistorico {
                display: none !important;
            }
            
            body.thermal-mode-active #areaFaltas {
                display: block !important;
            }
            
            body.thermal-mode-active #areaFaltas table {
                margin-top: 2mm !important;
            }
            
            /* TEXTO DE RELAT√ìRIO */
            body.thermal-mode-active .relatorio-titulo {
                text-align: center;
                font-weight: 900;
                font-size: 11px;
                margin: 1mm 0;
                color: #000 !important;
            }
            
            @page {
                size: 70mm auto;
                margin: 0mm;
            }
        }
        
        /* Responsividade para impress√£o */
        @media screen and (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
            
            .charts-row {
                grid-template-columns: 1fr !important;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }
        }
    </style>
</head>
<body>

<!-- TELA DE LOGIN COM LOGO (CORRIGIDA) -->
<div id="loginScreen">
    <div class="login-box">
        <!-- LOGO MANTIDA NA TELA DE LOGIN -->
        <img src="Souza-Farma-logomarca.png" alt="Logo Souza Farma" class="logo-img" 
             onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTUwIiBmaWxsPSIjZDMzZjJmIi8+Cjx0ZXh0IHg9Ijc1IiB5PSI3NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjIwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPlNGPC90ZXh0Pgo8L3N2Zz4='">
        <h1 style="color: var(--primary); margin: 10px 0; font-size: 24px;">SOUZA FARMA</h1>
        <input type="password" id="passInput" placeholder="Senha" style="width: 80%; margin-top: 15px; text-align: center;"><br>
        <button onclick="checkLogin()" class="btn-add" style="width: 100%; margin-top: 15px;">ENTRAR</button>
    </div>
</div>

<div id="mainApp">
    <div class="container">
        <header>
            <img src="Souza-Farma-logomarca.png" alt="Souza Farma" class="logo-img">
            <h1 class="nome-farmacia">SOUZA FARMA</h1>
            <div class="info-farma">
                <strong>Farm√°cia do Trabalhador</strong> | CNPJ 45.856.880/0001-30<br>
                Av. Jos√© Sarney n¬∫ 06, Bom Jesus ‚Äì S√£o Lu√≠s/MA<br>
                <small>Cuidando da sua sa√∫de, economia e pre√ßo baixo üíäüíâ</small>
            </div>
        </header>

        <div class="dashboard no-print">
            <div class="card card-vendas"><h4>Vendas Perdidas</h4><p id="dashVenda">R$ 0,00</p></div>
            <div class="card card-lucro"><h4>Lucro Perdido</h4><p id="dashLucro">R$ 0,00</p></div>
            <div class="card card-margem"><h4>Margem M√©dia</h4><p id="dashMargem">0%</p></div>
        </div>

        <div class="charts-row no-print">
            <div class="chart-container"><canvas id="graficoBarras"></canvas></div>
            <div class="chart-container"><canvas id="graficoPizza"></canvas></div>
        </div>

        <div class="tabs no-print">
            <button class="tab-btn active" id="btnTabFaltas" onclick="switchTab('faltas')">üõí Faltas Atuais</button>
            <button class="tab-btn" id="btnTabHist" onclick="switchTab('historico')">‚úÖ Hist√≥rico Compras</button>
        </div>

        <!-- NOVO: FILTROS DE DATA -->
        <div class="filtros-container no-print" id="filtrosContainer">
            <div class="filtros-titulo">
                <span>üîç FILTROS DE DATA</span>
            </div>
            <div class="filtros-grid">
                <div class="filtro-group">
                    <label class="filtro-label">Data Espec√≠fica</label>
                    <input type="date" id="filtroDataUnica">
                </div>
                
                <div class="filtro-group">
                    <label class="filtro-label">Per√≠odo - De</label>
                    <input type="date" id="filtroDataInicio">
                </div>
                
                <div class="filtro-group">
                    <label class="filtro-label">Per√≠odo - At√©</label>
                    <input type="date" id="filtroDataFim">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-filtro" onclick="aplicarFiltroData()">APLICAR FILTRO</button>
                    <button class="btn-limpar" onclick="limparFiltroData()">LIMPAR</button>
                </div>
                
                <div class="filtro-info" id="filtroInfo">
                    Mostrando todas as faltas. Use os filtros acima para buscar por data espec√≠fica ou per√≠odo.
                </div>
            </div>
        </div>

        <div id="areaFaltas">
            <div class="form-container no-print">
                <div class="form-grid">
                    <input type="text" id="desc" placeholder="Medicamento" required>
                    <input type="number" id="qtd" placeholder="Qtd" min="1" step="1" required>
                    <input type="number" id="custo" placeholder="Custo" step="0.01" min="0">
                    <input type="number" id="venda" placeholder="Venda" step="0.01" min="0">
                    <select id="motivo">
                        <option value="Estoque Zerado">Estoque Zerado</option>
                        <option value="Fornecedor Indispon√≠vel">Fornecedor Indispon√≠vel</option>
                        <option value="Produto Novo">Produto Novo</option>
                    </select>
                    <input type="date" id="dataReg">
                    <button id="btnAdd" class="btn-add" onclick="adicionarAoFirebase()">SALVAR</button>
                    <button id="btnUpdate" class="btn-update" onclick="salvarEdicaoFirebase()">ATUALIZAR</button>
                </div>
                <input type="hidden" id="editId">
                <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                    <small>Pressione ENTER no campo Medicamento para salvar rapidamente</small>
                </div>
            </div>
            <table>
                <thead><tr><th>Produto / Detalhes</th><th>Qtd</th><th>Custo/Venda</th><th>Lucro Total (%)</th><th>Venda Total</th><th class="no-print">A√ß√µes</th></tr></thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

        <div id="areaHistorico" style="display:none;">
            <!-- Filtros para hist√≥rico (opcional, pode adicionar depois) -->
            <table>
                <thead><tr><th>Produto</th><th>Data Falta</th><th>Data Compra</th><th>Pre√ßo M√©dio</th><th>A√ß√µes</th></tr></thead>
                <tbody id="corpoHistorico"></tbody>
            </table>
        </div>

        <div class="footer-controls no-print">
            <button class="btn-action" style="background:#d32f2f" onclick="gerarPDF()">üìë GERAR PDF</button>
            <button class="btn-action" style="background:#1565c0" onclick="exportarExcel()">üìä EXCEL</button>
            <button class="btn-action" style="background:#263238" onclick="imprimirTermica()">üßæ T√âRMICA</button>
            <button class="btn-action" style="background:#25d366" onclick="enviarWhatsApp()">üì≤ WHATSAPP</button>
            <button class="btn-action" style="background:#f44336" onclick="logout()">üîí SAIR</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC5-jTow8lk34iaKFhuSmJ8c1QpgoExOfE",
        authDomain: "souza-farma-8d08d.firebaseapp.com",
        databaseURL: "https://souza-farma-8d08d-default-rtdb.firebaseio.com",
        projectId: "souza-farma-8d08d",
        storageBucket: "souza-farma-8d08d.firebasestorage.app",
        messagingSenderId: "189166520636",
        appId: "1:189166520636:web:c97b7c7ead4e2d32b67639"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dados = [];
    let barChart, pieChart;
    let dadosFiltrados = [];
    let filtroAtivo = false;

    // FUN√á√ÉO PARA FORMATAR N√öMEROS COM V√çRGULA (padr√£o BR)
    function formatarNumeroBR(valor, casasDecimais = 2) {
        if (valor === null || valor === undefined || isNaN(valor)) return '0,00';
        
        // Arredonda para o n√∫mero de casas decimais especificado
        const valorArredondado = Number(valor).toFixed(casasDecimais);
        
        // Substitui ponto por v√≠rgula
        return valorArredondado.replace('.', ',');
    }

    // FUN√á√ÉO PARA FORMATAR MOEDA BRASILEIRA
    function formatarMoedaBR(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return 'R$ 0,00';
        
        // Formata como moeda brasileira
        return 'R$ ' + formatarNumeroBR(valor, 2);
    }

    // FUN√á√ÉO PARA CONVERTER V√çRGULA PARA PONTO (para c√°lculos)
    function converterParaDecimal(valorString) {
        if (!valorString) return 0;
        
        // Remove R$, espa√ßos e substitui v√≠rgula por ponto
        const limpo = valorString.toString()
            .replace('R$', '')
            .replace(' ', '')
            .replace('.', '')  // Remove pontos de milhar
            .replace(',', '.'); // Substitui v√≠rgula decimal por ponto
        
        return parseFloat(limpo) || 0;
    }

    // FUN√á√ÉO PARA CONVERTER DATA BR PARA ISO (DD/MM/AAAA -> AAAA-MM-DD)
    function converterDataBRparaISO(dataBR) {
        if (!dataBR) return null;
        const partes = dataBR.split('/');
        if (partes.length === 3) {
            return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
        }
        return null;
    }

    window.onload = () => {
        if(sessionStorage.getItem('logado') === 'true') { 
            document.getElementById('mainApp').style.display = 'block';
            carregarDados();
        } else { 
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('passInput').focus();
        }
        
        const hoje = new Date();
        const dataFormatada = hoje.toISOString().split('T')[0];
        document.getElementById('dataReg').value = dataFormatada;
        
        // Preencher datas padr√£o nos filtros
        const primeiraDataMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const primeiraDataFormatada = primeiraDataMes.toISOString().split('T')[0];
        
        document.getElementById('filtroDataUnica').value = dataFormatada;
        document.getElementById('filtroDataInicio').value = primeiraDataFormatada;
        document.getElementById('filtroDataFim').value = dataFormatada;
        
        document.getElementById('desc').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                adicionarAoFirebase();
            }
        });

        // Configurar campos num√©ricos para aceitar v√≠rgula
        document.getElementById('custo').addEventListener('blur', function() {
            const valor = this.value;
            if (valor && valor.includes('.')) {
                this.value = valor.replace('.', ',');
            }
        });

        document.getElementById('venda').addEventListener('blur', function() {
            const valor = this.value;
            if (valor && valor.includes('.')) {
                this.value = valor.replace('.', ',');
            }
        });
    };

    function checkLogin() { 
        if(document.getElementById('passInput').value === 'farma123') { 
            sessionStorage.setItem('logado', 'true'); 
            location.reload(); 
        } else { 
            alert("Senha Incorreta!"); 
            document.getElementById('passInput').value = '';
            document.getElementById('passInput').focus();
        } 
    }
    
    function logout() { 
        if(confirm("Deseja realmente sair do sistema?")) {
            sessionStorage.removeItem('logado'); 
            location.reload(); 
        }
    }
    
    function switchTab(t) {
        document.getElementById('areaFaltas').style.display = t === 'faltas' ? 'block' : 'none';
        document.getElementById('areaHistorico').style.display = t === 'historico' ? 'block' : 'none';
        document.getElementById('btnTabFaltas').classList.toggle('active', t === 'faltas');
        document.getElementById('btnTabHist').classList.toggle('active', t === 'historico');
        
        // Mostrar/ocultar filtros conforme a aba
        if (t === 'faltas') {
            document.getElementById('filtrosContainer').style.display = 'block';
        } else {
            document.getElementById('filtrosContainer').style.display = 'none';
        }
    }

    function carregarDados() {
        db.ref('faltas').on('value', snap => {
            dados = [];
            snap.forEach(i => { 
                if (i.val()) {
                    dados.push({id: i.key, ...i.val()}); 
                }
            });
            renderizar();
            atualizarGraficos();
        }, error => {
            console.error("Erro ao carregar dados:", error);
            alert("Erro ao carregar dados. Verifique sua conex√£o.");
        });
    }

    function renderizar() {
        const corpo = document.getElementById('corpoTabela');
        const corpoH = document.getElementById('corpoHistorico');
        corpo.innerHTML = ''; 
        corpoH.innerHTML = '';
        let tV = 0, tL = 0;

        // Usar dados filtrados se houver filtro ativo, sen√£o usar todos os dados
        const dadosParaRenderizar = filtroAtivo ? dadosFiltrados : dados.filter(item => !item.comprado);
        
        // Ordenar por data (mais recente primeiro)
        const dadosOrdenados = [...dadosParaRenderizar].sort((a, b) => {
            if (!a.rawDate || !b.rawDate) return 0;
            return new Date(b.rawDate) - new Date(a.rawDate);
        });

        dadosOrdenados.forEach(i => {
            if (!i.desc) return;
            
            const lucroT = (i.venda - i.custo) * i.qtd;
            const totalV = i.venda * i.qtd;
            const margemUnit = i.venda > 0 ? ((i.venda - i.custo) / i.venda) * 100 : 0;

            if(!i.comprado) {
                tV += totalV; 
                tL += lucroT;
                let classeABC = "";
                let etiqueta = "";
                if (lucroT >= 50) {
                    classeABC = "high-priority";
                    etiqueta = '<span class="badge-abc badge-red">ALTA PERDA</span>';
                } else if (margemUnit >= 35) {
                    classeABC = "high-margin";
                    etiqueta = '<span class="badge-abc badge-green">ALTA MARGEM</span>';
                }

                corpo.innerHTML += `<tr class="${classeABC}">
                    <td><strong>${i.desc}</strong><br><small>${i.data || i.rawDate} | ${i.motivo || 'N√£o informado'}</small><br>${etiqueta}</td>
                    <td>${i.qtd}</td>
                    <td>C: ${formatarMoedaBR(i.custo || 0)} / V: ${formatarMoedaBR(i.venda || 0)}</td>
                    <td>${formatarMoedaBR(lucroT)}<br><small>${formatarNumeroBR(margemUnit, 1)}%</small></td>
                    <td><strong>${formatarMoedaBR(totalV)}</strong></td>
                    <td class="no-print">
                        <button title="Comprado" onclick="marcarComprado('${i.id}')" style="cursor:pointer; border:none; background:none; font-size:18px;">‚úÖ</button>
                        <button title="Editar" onclick="editarItem('${i.id}')" style="cursor:pointer; border:none; background:none; font-size:18px; margin-left:8px;">‚úé</button>
                        <button title="Remover" onclick="removerItem('${i.id}')" style="cursor:pointer; border:none; background:none; color:red; font-size:18px; margin-left:8px;">üóë</button>
                    </td></tr>`;
            } else {
                // Para hist√≥rico (quando na aba de hist√≥rico)
                const comprasAnteriores = dados.filter(x => x.desc === i.desc && x.comprado && x.id !== i.id);
                let trend = "‚Äì";
                if(comprasAnteriores.length > 0) {
                    const ultima = comprasAnteriores[0].custo;
                    trend = i.custo > ultima ? "üî∫" : (i.custo < ultima ? "üîª" : "‚Äì");
                }
                corpoH.innerHTML += `<tr>
                    <td><strong>${i.desc}</strong></td>
                    <td>${i.data || i.rawDate}</td>
                    <td>${i.dataCompra || 'N√£o informada'}</td>
                    <td>${formatarMoedaBR(i.custo || 0)} ${trend}</td>
                    <td><button onclick="estornar('${i.id}')" style="background:#607d8b; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">‚Ü© Estornar</button></td></tr>`;
            }
        });
        
        // Atualizar dashboard
        document.getElementById('dashVenda').innerText = formatarMoedaBR(tV);
        document.getElementById('dashLucro').innerText = formatarMoedaBR(tL);
        document.getElementById('dashMargem').innerText = tV > 0 ? formatarNumeroBR((tL/tV)*100, 1) + "%" : "0%";
        
        // Atualizar contador de itens
        const totalItens = dadosParaRenderizar.length;
        const infoFiltro = document.getElementById('filtroInfo');
        
        if (filtroAtivo) {
            infoFiltro.innerHTML = `<strong>Filtro aplicado:</strong> Mostrando ${totalItens} item(s) filtrado(s). <span style="color: #d32f2f; cursor: pointer;" onclick="limparFiltroData()">[Limpar filtro]</span>`;
        } else {
            infoFiltro.innerHTML = `Mostrando todas as ${totalItens} falta(s). Use os filtros acima para buscar por data espec√≠fica ou per√≠odo.`;
        }
    }

    // NOVA FUN√á√ÉO: APLICAR FILTRO POR DATA
    function aplicarFiltroData() {
        const dataUnica = document.getElementById('filtroDataUnica').value;
        const dataInicio = document.getElementById('filtroDataInicio').value;
        const dataFim = document.getElementById('filtroDataFim').value;
        
        // Verificar qual tipo de filtro ser√° aplicado
        if (dataUnica) {
            // Filtro por data √∫nica
            const dataFormatadaBR = dataUnica.split('-').reverse().join('/');
            dadosFiltrados = dados.filter(item => {
                // Verificar se a data do item corresponde √† data do filtro
                return (item.data === dataFormatadaBR || item.rawDate === dataUnica) && !item.comprado;
            });
            
            if (dadosFiltrados.length === 0) {
                alert(`Nenhuma falta encontrada para a data ${dataFormatadaBR}`);
                return;
            }
            
            filtroAtivo = true;
            document.getElementById('filtroInfo').innerHTML = `<strong>Filtro:</strong> Mostrando faltas da data ${dataFormatadaBR} (${dadosFiltrados.length} item(s))`;
            
        } else if (dataInicio && dataFim) {
            // Filtro por per√≠odo
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            
            if (inicio > fim) {
                alert("A data inicial n√£o pode ser maior que a data final!");
                return;
            }
            
            dadosFiltrados = dados.filter(item => {
                if (item.comprado) return false;
                
                // Tentar usar rawDate (formato ISO) primeiro, depois data (formato BR)
                let dataItem = null;
                if (item.rawDate) {
                    dataItem = new Date(item.rawDate);
                } else if (item.data) {
                    // Converter data BR para ISO
                    const dataISO = converterDataBRparaISO(item.data);
                    if (dataISO) {
                        dataItem = new Date(dataISO);
                    }
                }
                
                if (!dataItem) return false;
                
                // Verificar se a data est√° dentro do per√≠odo
                return dataItem >= inicio && dataItem <= fim;
            });
            
            if (dadosFiltrados.length === 0) {
                const inicioBR = dataInicio.split('-').reverse().join('/');
                const fimBR = dataFim.split('-').reverse().join('/');
                alert(`Nenhuma falta encontrada para o per√≠odo de ${inicioBR} a ${fimBR}`);
                return;
            }
            
            filtroAtivo = true;
            const inicioBR = dataInicio.split('-').reverse().join('/');
            const fimBR = dataFim.split('-').reverse().join('/');
            document.getElementById('filtroInfo').innerHTML = `<strong>Filtro:</strong> Mostrando faltas de ${inicioBR} a ${fimBR} (${dadosFiltrados.length} item(s))`;
            
        } else {
            alert("Selecione uma data espec√≠fica OU um per√≠odo (data inicial e final) para filtrar.");
            return;
        }
        
        // Renderizar os dados filtrados
        renderizar();
        atualizarGraficosFiltrados();
    }

    // NOVA FUN√á√ÉO: LIMPAR FILTRO
    function limparFiltroData() {
        filtroAtivo = false;
        dadosFiltrados = [];
        
        // Resetar campos de filtro para valores padr√£o
        const hoje = new Date();
        const dataFormatada = hoje.toISOString().split('T')[0];
        const primeiraDataMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        const primeiraDataFormatada = primeiraDataMes.toISOString().split('T')[0];
        
        document.getElementById('filtroDataUnica').value = dataFormatada;
        document.getElementById('filtroDataInicio').value = primeiraDataFormatada;
        document.getElementById('filtroDataFim').value = dataFormatada;
        
        // Renderizar todos os dados novamente
        renderizar();
        atualizarGraficos();
    }

    // NOVA FUN√á√ÉO: ATUALIZAR GR√ÅFICOS COM DADOS FILTRADOS
    function atualizarGraficosFiltrados() {
        const dias = {};
        dadosFiltrados.forEach(i => {
            if (i.data) {
                dias[i.data] = (dias[i.data] || 0) + ((i.venda || 0) * (i.qtd || 0));
            }
        });
        
        const labels = Object.keys(dias).sort();
        if(barChart) barChart.destroy();
        
        if (labels.length > 0) {
            barChart = new Chart(document.getElementById('graficoBarras'), {
                type: 'bar', 
                data: { 
                    labels, 
                    datasets: [{
                        label: 'Perda Di√°ria R$', 
                        data: labels.map(l => dias[l]), 
                        backgroundColor: '#d32f2f',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Perda: ${formatarMoedaBR(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatarMoedaBR(value);
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Se n√£o houver dados para o gr√°fico, mostrar mensagem
            const ctx = document.getElementById('graficoBarras').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('Sem dados para o per√≠odo filtrado', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        const m = { 'Estoque Zerado': 0, 'Fornecedor Indispon√≠vel': 0, 'Produto Novo': 0 };
        dadosFiltrados.forEach(i => {
            const motivo = i.motivo || 'Estoque Zerado';
            m[motivo] = (m[motivo] || 0) + 1;
        });
        
        if(pieChart) pieChart.destroy();
        
        if (dadosFiltrados.length > 0) {
            pieChart = new Chart(document.getElementById('graficoPizza'), {
                type: 'pie', 
                data: { 
                    labels: Object.keys(m), 
                    datasets: [{
                        data: Object.values(m), 
                        backgroundColor: ['#0277bd', '#fbc02d', '#2e7d32'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    } 
                }
            });
        } else {
            // Se n√£o houver dados para o gr√°fico, mostrar mensagem
            const ctx = document.getElementById('graficoPizza').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.fillText('Sem dados para o per√≠odo filtrado', ctx.canvas.width / 2, ctx.canvas.height / 2);
        }
    }

    function adicionarAoFirebase() {
        const d = document.getElementById('desc').value.trim().toUpperCase();
        const q = parseFloat(document.getElementById('qtd').value);
        
        if(!d || d.length < 2) {
            alert("Preencha o nome do medicamento (m√≠nimo 2 caracteres)!");
            document.getElementById('desc').focus();
            return;
        }
        
        if(!q || q < 1) {
            alert("Quantidade deve ser pelo menos 1!");
            document.getElementById('qtd').focus();
            return;
        }
        
        // Usar a fun√ß√£o de convers√£o para tratar v√≠rgula
        const custo = converterParaDecimal(document.getElementById('custo').value);
        const venda = converterParaDecimal(document.getElementById('venda').value);
        
        if (venda > 0 && custo > venda) {
            if (!confirm("Custo maior que venda! Deseja continuar?")) {
                return;
            }
        }
        
        const dataValue = document.getElementById('dataReg').value;
        const dataFormatada = dataValue.split('-').reverse().join('/');
        
        db.ref('faltas').push({
            desc: d, 
            qtd: q, 
            custo: custo,
            venda: venda,
            motivo: document.getElementById('motivo').value,
            rawDate: dataValue,
            data: dataFormatada,
            comprado: false,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            limparCampos();
            document.getElementById('desc').focus();
        }).catch(error => {
            console.error("Erro ao salvar:", error);
            alert("Erro ao salvar. Tente novamente.");
        });
    }

    function editarItem(id) {
        const i = dados.find(x => x.id === id);
        if (!i) return;
        
        document.getElementById('desc').value = i.desc;
        document.getElementById('qtd').value = i.qtd;
        document.getElementById('custo').value = formatarNumeroBR(i.custo, 2);
        document.getElementById('venda').value = formatarNumeroBR(i.venda, 2);
        document.getElementById('dataReg').value = i.rawDate || new Date().toISOString().split('T')[0];
        document.getElementById('editId').value = id;
        document.getElementById('btnAdd').style.display = 'none';
        document.getElementById('btnUpdate').style.display = 'block';
        document.getElementById('desc').focus();
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function salvarEdicaoFirebase() {
        const id = document.getElementById('editId').value;
        if (!id) return;
        
        const dt = document.getElementById('dataReg').value;
        const dataFormatada = dt.split('-').reverse().join('/');
        
        // Converter valores com v√≠rgula para decimal
        const custo = converterParaDecimal(document.getElementById('custo').value);
        const venda = converterParaDecimal(document.getElementById('venda').value);
        
        db.ref('faltas/'+id).update({
            desc: document.getElementById('desc').value.trim().toUpperCase(),
            qtd: parseFloat(document.getElementById('qtd').value),
            custo: custo,
            venda: venda,
            rawDate: dt, 
            data: dataFormatada,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            document.getElementById('btnAdd').style.display = 'block';
            document.getElementById('btnUpdate').style.display = 'none';
            limparCampos();
            document.getElementById('desc').focus();
        }).catch(error => {
            console.error("Erro ao atualizar:", error);
            alert("Erro ao atualizar. Tente novamente.");
        });
    }

    function marcarComprado(id) { 
        if (confirm("Marcar este item como comprado?")) {
            const dataCompra = new Date().toLocaleDateString('pt-BR');
            db.ref('faltas/'+id).update({
                comprado: true, 
                dataCompra: dataCompra,
                compradoTimestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
    }
    
    function estornar(id) { 
        if (confirm("Estornar compra e voltar para faltas?")) {
            db.ref('faltas/'+id).update({
                comprado: false, 
                dataCompra: null,
                compradoTimestamp: null
            });
        }
    }
    
    function removerItem(id) { 
        if(confirm("Apagar permanentemente este registro?")) {
            db.ref('faltas/'+id).remove().catch(error => {
                console.error("Erro ao remover:", error);
                alert("Erro ao remover item.");
            });
        }
    }
    
    function limparCampos() { 
        document.getElementById('desc').value=''; 
        document.getElementById('qtd').value='1'; 
        document.getElementById('custo').value=''; 
        document.getElementById('venda').value=''; 
        document.getElementById('editId').value='';
        document.getElementById('dataReg').value = new Date().toISOString().split('T')[0];
    }

    function atualizarGraficos() {
        const dadosParaGraficos = filtroAtivo ? dadosFiltrados : dados.filter(i => !i.comprado);
        
        const dias = {};
        dadosParaGraficos.forEach(i => {
            if (i.data) {
                dias[i.data] = (dias[i.data] || 0) + ((i.venda || 0) * (i.qtd || 0));
            }
        });
        
        const labels = Object.keys(dias).sort().slice(-7);
        if(barChart) barChart.destroy();
        
        if (labels.length > 0) {
            barChart = new Chart(document.getElementById('graficoBarras'), {
                type: 'bar', 
                data: { 
                    labels, 
                    datasets: [{
                        label: 'Perda Di√°ria R$', 
                        data: labels.map(l => dias[l]), 
                        backgroundColor: '#d32f2f',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Perda: ${formatarMoedaBR(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatarMoedaBR(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        const m = { 'Estoque Zerado': 0, 'Fornecedor Indispon√≠vel': 0, 'Produto Novo': 0 };
        dadosParaGraficos.forEach(i => {
            const motivo = i.motivo || 'Estoque Zerado';
            m[motivo] = (m[motivo] || 0) + 1;
        });
        
        if(pieChart) pieChart.destroy();
        
        if (dadosParaGraficos.length > 0) {
            pieChart = new Chart(document.getElementById('graficoPizza'), {
                type: 'pie', 
                data: { 
                    labels: Object.keys(m), 
                    datasets: [{
                        data: Object.values(m), 
                        backgroundColor: ['#0277bd', '#fbc02d', '#2e7d32'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    } 
                }
            });
        }
    }

    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(20); 
        doc.setTextColor(211, 47, 47);
        doc.text("SOUZA FARMA - RELAT√ìRIO DE GEST√ÉO", 14, 20);
        doc.setFontSize(10); 
        doc.setTextColor(100);
        doc.text("Cuidando da sua sa√∫de, economia e pre√ßo baixo", 14, 28);
        
        // Usar dados filtrados se houver filtro ativo
        const dadosParaPDF = filtroAtivo ? dadosFiltrados : dados.filter(i => !i.comprado);
        
        const rows = dadosParaPDF.map(i => [
            i.data || i.rawDate, 
            i.desc, 
            i.qtd, 
            i.motivo || 'N√£o informado', 
            formatarMoedaBR((i.venda || 0) * (i.qtd || 0))
        ]);
        
        doc.autoTable({ 
            head: [['Data', 'Produto', 'Qtd', 'Motivo', 'Total']], 
            body: rows, 
            startY: 35, 
            headStyles: {fillColor: [38, 50, 56]},
            styles: {fontSize: 9}
        });
        
        const totalPerda = dadosParaPDF
            .reduce((sum, i) => sum + ((i.venda || 0) * (i.qtd || 0)), 0);
        
        doc.setFontSize(11);
        doc.setTextColor(211, 47, 47);
        doc.text(`TOTAL PERDAS: ${formatarMoedaBR(totalPerda)}`, 14, doc.lastAutoTable.finalY + 10);
        
        // Adicionar informa√ß√£o do filtro se aplic√°vel
        if (filtroAtivo) {
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Relat√≥rio filtrado - ${document.getElementById('filtroInfo').textContent}`, 14, doc.lastAutoTable.finalY + 20);
        }
        
        doc.save(`souza_farma_relatorio_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function exportarExcel() {
        // Usar dados filtrados se houver filtro ativo
        const dadosParaExcel = filtroAtivo ? dadosFiltrados : dados.filter(i => !i.comprado);
        
        let csv = '\uFEFFData;Produto;Qtd;Custo;Venda;Lucro;Status;Motivo\n';
        dadosParaExcel.forEach(i => {
            const lucro = (i.venda || 0) - (i.custo || 0);
            csv += `${i.data || i.rawDate};${i.desc};${i.qtd};${formatarNumeroBR(i.custo || 0)};${formatarNumeroBR(i.venda || 0)};${formatarNumeroBR(lucro)};${i.comprado ? 'Comprado':'Falta'};${i.motivo || ''}\n`;
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8'}));
        link.download = `souza_farma_${new Date().toISOString().slice(0,10)}.csv`; 
        link.click();
    }

    function imprimirTermica() {
        // Adicionar um t√≠tulo ao relat√≥rio antes de imprimir
        const tabelaOriginal = document.getElementById('areaFaltas').innerHTML;
        
        // Adicionar informa√ß√£o do filtro se aplic√°vel
        let tituloRelatorio = '<div class="relatorio-titulo">RELAT√ìRIO DE FALTAS - SOUZA FARMA</div>';
        if (filtroAtivo) {
            const infoFiltro = document.getElementById('filtroInfo').textContent;
            tituloRelatorio += `<div class="relatorio-titulo" style="font-size: 9px;">${infoFiltro}</div>`;
        }
        
        document.getElementById('areaFaltas').innerHTML = tituloRelatorio + tabelaOriginal;
        
        // Adicionar classe especial para impress√£o t√©rmica
        document.body.classList.add('thermal-mode-active');
        
        // For√ßar estilos de impress√£o escuros
        const style = document.createElement('style');
        style.innerHTML = `
            @media print {
                body.thermal-mode-active * {
                    color: #000000 !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                table { border: 2px solid #000 !important; }
                th, td { border: 1px solid #000 !important; }
                th { background: #000 !important; color: #fff !important; }
            }
        `;
        document.head.appendChild(style);
        
        // Esperar um momento para aplicar os estilos
        setTimeout(() => {
            window.print();
            
            // Remover a classe ap√≥s a impress√£o e restaurar a tabela
            setTimeout(() => {
                document.body.classList.remove('thermal-mode-active');
                document.getElementById('areaFaltas').innerHTML = tabelaOriginal;
                document.head.removeChild(style);
            }, 500);
        }, 200);
    }
    
    function enviarWhatsApp() {
        // Usar dados filtrados se houver filtro ativo
        const faltas = filtroAtivo ? dadosFiltrados : dados.filter(i => !i.comprado);
        
        if (faltas.length === 0) {
            alert("N√£o h√° itens em falta para enviar!");
            return;
        }
        
        let m = "*SOUZA FARMA - RELAT√ìRIO DE FALTAS*%0A%0A";
        m += `Data: ${new Date().toLocaleDateString('pt-BR')}%0A`;
        m += `Total de itens: ${faltas.length}%0A`;
        
        // Adicionar informa√ß√£o do filtro se aplic√°vel
        if (filtroAtivo) {
            const infoFiltro = document.getElementById('filtroInfo').textContent;
            m += `Filtro: ${infoFiltro}%0A`;
        }
        
        m += `%0A`;
        
        faltas.forEach(i => {
            const total = (i.venda || 0) * (i.qtd || 0);
            m += `‚Ä¢ ${i.desc} (Qtd: ${i.qtd}) - ${formatarMoedaBR(total)}%0A`;
        });
        
        const totalPerda = faltas.reduce((sum, i) => sum + ((i.venda || 0) * (i.qtd || 0)), 0);
        m += `%0A*PERDA ESTIMADA: ${formatarMoedaBR(totalPerda)}*`;
        m += `%0A%0A_Relat√≥rio gerado automaticamente pelo Sistema Souza Farma_`;
        
        window.open(`https://wa.me/5598986287296?text=${m}`);
    }
</script>
</body>
</html>
