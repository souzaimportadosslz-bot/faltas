<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUZA FARMA - Intelig√™ncia Cloud</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d32f2f; --secondary: #fbc02d; --success: #2e7d32; --light: #f8f9fa; --blue: #0277bd; --dark: #263238; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #eaeff2; color: #333; }
        
        /* Tela de Login */
        #loginScreen { display: flex; align-items: center; justify-content: center; height: 100vh; background: var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* Container Principal */
        #mainApp { display: none; padding: 20px; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 25px; }
        .logo-img { max-width: 180px; margin-bottom: 10px; }
        
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .card-vendas { background: var(--blue); } .card-lucro { background: var(--success); } .card-margem { background: #5e35b1; }
        .card h4 { margin: 0; font-size: 11px; text-transform: uppercase; }
        .card p { margin: 5px 0 0; font-size: 20px; font-weight: bold; }

        .filters { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .form-container { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #dee2e6; }
        .form-grid { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1fr 1fr 1.2fr auto; gap: 10px; }
        
        input, select, button { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; }
        .btn-add { background: var(--primary); color: white; cursor: pointer; font-weight: bold; border:none; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--dark); color: white; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        
        /* Curva ABC / Prioridade */
        .high-priority { border-left: 5px solid #ff1744; background: #fff5f5; }
        .high-margin { border-left: 5px solid #00e676; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; color: white; }
        .badge-red { background: #ff1744; } .badge-green { background: #00c853; }

        .footer-controls { display: flex; gap: 10px; margin-top: 30px; justify-content: center; flex-wrap: wrap; }
        .btn-action { padding: 12px 20px; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        @media print {
            .no-print { display: none !important; }
            body.thermal-mode-active { width: 70mm; font-family: "Arial Black", sans-serif !important; color: #000 !important; }
            body.thermal-mode-active .container { width: 70mm !important; padding: 0.5cm !important; margin: 0 !important; }
            body.thermal-mode-active * { color: #000 !important; font-weight: 900 !important; }
            @page { margin: 0; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <img src="Souza-Farma-logomarca.png" alt="Souza Farma" class="logo-img" onerror="this.style.display='none'"><br>
        <h2>Acesso Souza Farma</h2>
        <input type="password" id="passInput" placeholder="Digite a senha..." style="width: 80%; margin-bottom: 20px;"><br>
        <button onclick="checkLogin()" class="btn-add" style="width: 100%;">ENTRAR NO SISTEMA</button>
    </div>
</div>

<div id="mainApp">
    <div class="container">
        <header>
            <img src="Souza-Farma-logomarca.png" alt="Souza Farma" class="logo-img" onerror="this.style.display='none'">
            <div class="info-farma">
                <strong>Farm√°cia do Trabalhador</strong> | CNPJ 45.856.880/0001-30<br>
                Av. Jos√© Sarney n¬∫ 06, Bom Jesus ‚Äì S√£o Lu√≠s/MA
            </div>
        </header>

        <div class="dashboard">
            <div class="card card-vendas"><h4>Total Vendas Perdidas</h4><p id="dashVenda">R$ 0,00</p></div>
            <div class="card card-lucro"><h4>Total Lucro Perdido</h4><p id="dashLucro">R$ 0,00</p></div>
            <div class="card card-margem"><h4>Margem M√©dia Geral</h4><p id="dashMargem">0.00%</p></div>
        </div>

        <div class="filters no-print">
            <strong>Filtro por Per√≠odo:</strong>
            <input type="date" id="filterStart"> at√© <input type="date" id="filterEnd">
            <button onclick="filtrarDados()" style="background: var(--blue); color:white; border:none; cursor:pointer;">APLICAR FILTRO</button>
            <button onclick="carregarTudo()" style="background: #ccc; border:none; cursor:pointer;">LIMPAR</button>
        </div>

        <div class="form-container no-print">
            <div class="form-grid">
                <input type="text" id="desc" placeholder="Medicamento">
                <input type="number" id="qtd" placeholder="Qtd">
                <input type="number" id="custo" placeholder="Custo" step="0.01">
                <input type="number" id="venda" placeholder="Venda" step="0.01">
                <select id="motivo">
                    <option value="Estoque Zerado">Estoque Zerado</option>
                    <option value="Fornecedor Indispon√≠vel">Fornecedor Indispon√≠vel</option>
                    <option value="Produto Novo">Produto Novo</option>
                </select>
                <input type="date" id="dataReg">
                <button id="btnAdd" class="btn-add" onclick="adicionarAoFirebase()">SALVAR</button>
            </div>
        </div>

        <div id="tabelaArea">
            <table>
                <thead>
                    <tr>
                        <th>Produto/Motivo</th>
                        <th>Qtd</th>
                        <th>Pre√ßos (U)</th>
                        <th>Lucro</th>
                        <th>Total Venda</th>
                        <th class="no-print">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>

        <div class="footer-controls no-print">
            <button class="btn-action" style="background:#455a64" onclick="imprimir('A4')">üñ®Ô∏è A4</button>
            <button class="btn-action" style="background:#263238" onclick="imprimir('70mm')">üßæ T√âRMICA</button>
            <button class="btn-action" style="background:#25d366" onclick="enviarWhatsApp()">üì≤ WHATSAPP</button>
            <button class="btn-action" style="background:#1565c0" onclick="exportarExcel()">üìä EXCEL</button>
            <button class="btn-action" style="background:#f44336" onclick="location.reload()">üîí SAIR</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC5-jTow8lk34iaKFhuSmJ8c1QpgoExOfE",
        authDomain: "souza-farma-8d08d.firebaseapp.com",
        databaseURL: "https://souza-farma-8d08d-default-rtdb.firebaseio.com",
        projectId: "souza-farma-8d08d",
        storageBucket: "souza-farma-8d08d.firebasestorage.app",
        messagingSenderId: "189166520636",
        appId: "1:189166520636:web:c97b7c7ead4e2d32b67639"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let dadosCompletos = [];
    document.getElementById('dataReg').valueAsDate = new Date();

    function checkLogin() {
        const pass = document.getElementById('passInput').value;
        if(pass === 'farma123') { // SENHA PADR√ÉO AQUI
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            carregarTudo();
        } else { alert("Senha incorreta!"); }
    }

    function adicionarAoFirebase() {
        const desc = document.getElementById('desc').value;
        const qtd = parseFloat(document.getElementById('qtd').value);
        const custo = parseFloat(document.getElementById('custo').value) || 0;
        const venda = parseFloat(document.getElementById('venda').value) || 0;
        const motivo = document.getElementById('motivo').value;
        const data = document.getElementById('dataReg').value;

        if(!desc || !qtd || !venda) return alert("Preencha os campos!");

        db.ref('faltas').push({
            desc: desc.toUpperCase(),
            qtd, custo, venda, motivo,
            rawDate: data,
            data: data.split('-').reverse().join('/'),
            timestamp: Date.now()
        });
        limparCampos();
    }

    function carregarTudo() {
        db.ref('faltas').on('value', (snapshot) => {
            dadosCompletos = [];
            snapshot.forEach((item) => { dadosCompletos.push({ id: item.key, ...item.val() }); });
            renderizar(dadosCompletos);
        });
    }

    function filtrarDados() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        if(!start || !end) return alert("Selecione as duas datas!");
        const filtrados = dadosCompletos.filter(i => i.rawDate >= start && i.rawDate <= end);
        renderizar(filtrados);
    }

    function renderizar(lista) {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';
        let tVenda = 0, tCusto = 0;

        [...lista].reverse().forEach(i => {
            const vTotal = i.venda * i.qtd;
            const lucroTotalItem = (i.venda - i.custo) * i.qtd;
            const margemUnit = i.venda > 0 ? ((i.venda - i.custo) / i.venda) * 100 : 0;
            
            tVenda += vTotal; tCusto += i.custo * i.qtd;

            // L√≥gica de Prioridade (Curva ABC)
            let priorityClass = '';
            let badge = '';
            if(lucroTotalItem >= 50) { priorityClass = 'high-priority'; badge = '<span class="badge badge-red">ALTA PERDA</span>'; }
            else if(margemUnit >= 35) { priorityClass = 'high-margin'; badge = '<span class="badge badge-green">ALTA MARGEM</span>'; }

            corpo.innerHTML += `
                <tr class="${priorityClass}">
                    <td><strong>${i.desc}</strong><br><small>${i.data} | ${i.motivo}</small> ${badge}</td>
                    <td>${i.qtd}</td>
                    <td>C: ${i.custo.toFixed(2)}<br>V: ${i.venda.toFixed(2)}</td>
                    <td>R$ ${lucroTotalItem.toFixed(2)}<br><small>${margemUnit.toFixed(1)}%</small></td>
                    <td><strong>R$ ${vTotal.toFixed(2)}</strong></td>
                    <td class="no-print">
                        <button onclick="removerItem('${i.id}')" style="color:red; border:none; cursor:pointer;">üóë</button>
                    </td>
                </tr>`;
        });
        atualizarDashboard(tVenda, tCusto);
    }

    function atualizarDashboard(v, c) {
        const lucro = v - c;
        const margem = v > 0 ? (lucro / v) * 100 : 0;
        document.getElementById('dashVenda').innerText = `R$ ${v.toFixed(2)}`;
        document.getElementById('dashLucro').innerText = `R$ ${lucro.toFixed(2)}`;
        document.getElementById('dashMargem').innerText = `${margem.toFixed(2)}%`;
        document.getElementById('totalFinalTabela').innerText = `R$ ${v.toFixed(2)}`;
    }

    function imprimir(formato) {
        if (formato === '70mm') document.body.classList.add('thermal-mode-active');
        else document.body.classList.remove('thermal-mode-active');
        setTimeout(() => { window.print(); }, 300);
    }

    function exportarExcel() {
        let csv = '\uFEFFData;Produto;Motivo;Qtd;Custo;Venda;Lucro;Margem%\n';
        dadosCompletos.forEach(i => {
            let luc = (i.venda - i.custo)*i.qtd;
            let marg = i.venda > 0 ? ((i.venda-i.custo)/i.venda)*100 : 0;
            csv += `${i.data};${i.desc};${i.motivo};${i.qtd};${i.custo};${i.venda};${luc.toFixed(2)};${marg.toFixed(1)}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "souza_farma_relatorio.csv";
        link.click();
    }

    function removerItem(id) { if(confirm("Apagar da nuvem?")) db.ref('faltas/' + id).remove(); }
    function limparCampos() { document.getElementById('desc').value = ''; document.getElementById('qtd').value = ''; document.getElementById('custo').value = ''; document.getElementById('venda').value = ''; }
</script>
</body>
</html>
